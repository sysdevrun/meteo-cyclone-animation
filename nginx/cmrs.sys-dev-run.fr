# Map to validate CORS origins: cyclones.re subdomains and localhost on any port
map $http_origin $cors_origin {
	default "";
	"~^https?://([a-zA-Z0-9-]+\.)*cyclones\.re$" $http_origin;
	"~^https?://localhost(:[0-9]+)?$" $http_origin;
}

server {
	server_name cmrs.sys-dev-run.fr;

	listen 80;
	listen [::]:80;

	return 301 https://$server_name$request_uri;
}

server {
	server_name cmrs.sys-dev-run.fr;

	listen 443 ssl http2;
	listen [::]:443 ssl http2;

	ssl_certificate /etc/nginx/tls/_.sys-dev-run.fr.crt;
	ssl_certificate_key /etc/nginx/tls/_.sys-dev-run.fr.key;

	root /home/chtitux/wd/meteo-cyclone-animation;

	index index.html;
	access_log /var/log/nginx/cmrs.sys-dev-run.fr_access.log;
	error_log /var/log/nginx/cmrs.sys-dev-run.fr_error.log info;

	add_header Strict-Transport-Security max-age=15768000;

	# CORS headers for cyclones.re subdomains and localhost
	add_header Access-Control-Allow-Origin $cors_origin always;
	add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
	add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept" always;

	# Disable cache for JSON data files so they're always refetched
	location ~ ^/data/.*\.json$ {
		add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
		add_header Pragma "no-cache" always;
		add_header Expires "0" always;
		add_header Access-Control-Allow-Origin $cors_origin always;
		add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
		add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept" always;
		try_files $uri =404;
	}

	# First attempt to serve request as file, then
	# as directory, then fall back to displaying a 404.
	try_files $uri $uri/ =404;
}
